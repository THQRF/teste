<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cubo Multiartista Online - Corrigido</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/photon-web-sdk@4.1.0/dist/photon-sdk-js.min.js"></script>
    <script src="config.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; }
        canvas { display: block; }
        #gui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        #status-bar { 
            position: absolute; top: 10px; right: 10px; 
            background: rgba(0,0,0,0.7); color: #0f0; padding: 10px; border-radius: 5px;
            pointer-events: auto; font-family: monospace;
        }
        #chat-container {
            position: absolute; bottom: 20px; left: 20px;
            width: 300px; height: 200px; background: rgba(0,0,0,0.5);
            color: white; padding: 10px; overflow-y: auto; pointer-events: auto;
        }
    </style>
</head>
<body>

    <div id="gui">
        <div id="status-bar">Status: Desconectado</div>
        <div id="chat-container" id="chat">
            <div id="messages"></div>
        </div>
    </div>

    <script>
    // Variáveis Globais
    let scene, camera, renderer, myCube;
    let client;
    let otherPlayers = {};
    const keys = {};

    // 1. INICIALIZAÇÃO DO THREE.JS (O Cenário)
    function initThree() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 10);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Luzes
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(5, 10, 7);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040));

        // Chão de Grade
        const grid = new THREE.GridHelper(100, 100, 0x444444, 0x222222);
        scene.add(grid);

        // O Meu Cubo
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const material = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
        myCube = new THREE.Mesh(geometry, material);
        scene.add(myCube);

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    }

    // 2. INICIALIZAÇÃO DO PHOTON (A Rede)
    function initPhoton() {
        const statusDisp = document.getElementById('status-bar');

        if (typeof Photon === 'undefined') {
            statusDisp.style.color = 'red';
            statusDisp.innerText = "Erro: Biblioteca Photon não carregada!";
            return;
        }

        client = new Photon.LoadBalancing.LoadBalancingClient(
            Photon.ConnectionProtocol.Wss, 
            SERVER_CONFIG.APP_ID, 
            SERVER_CONFIG.APP_VERSION
        );

        client.onStateChange = (state) => {
            statusDisp.innerText = "Status: " + Photon.LoadBalancing.Handlers.StateToName(state);
            if (state === Photon.LoadBalancing.LoadBalancingClient.State.ConnectedToMaster) {
                client.joinOrCreateRoom("SalaPrincipal");
            }
        };

        // Evento para receber movimento de outros
        client.onEvent = (code, content, actorNr) => {
            if (code === 2) { // Evento de posição
                if (!otherPlayers[actorNr]) {
                    const geometry = new THREE.BoxGeometry(1, 1, 1);
                    const material = new THREE.MeshStandardMaterial({ color: 0xff0000 });
                    otherPlayers[actorNr] = new THREE.Mesh(geometry, material);
                    scene.add(otherPlayers[actorNr]);
                }
                otherPlayers[actorNr].position.set(content.x, content.y, content.z);
            }
        };

        client.connectToRegionMaster(SERVER_CONFIG.REGION);
    }

    // 3. LOOP DE ANIMAÇÃO E MOVIMENTO
    function animate() {
        requestAnimationFrame(animate);

        const speed = 0.1;
        let moved = false;

        if (keys['w']) { myCube.position.z -= speed; moved = true; }
        if (keys['s']) { myCube.position.z += speed; moved = true; }
        if (keys['a']) { myCube.position.x -= speed; moved = true; }
        if (keys['d']) { myCube.position.x += speed; moved = true; }

        if (moved && client && client.isJoinedToRoom()) {
            client.raiseEvent(2, { 
                x: myCube.position.x, 
                y: myCube.position.y, 
                z: myCube.position.z 
            });
        }

        // Suavizar câmera atrás do cubo
        const targetCam = new THREE.Vector3(myCube.position.x, myCube.position.y + 5, myCube.position.z + 10);
        camera.position.lerp(targetCam, 0.1);
        camera.lookAt(myCube.position);

        renderer.render(scene, camera);
    }

    // CONTROLES
    window.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);

    // INÍCIO DE TUDO
    window.onload = () => {
        initThree();
        initPhoton();
        animate();
    };
    </script>
</body>
</html>
