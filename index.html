<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cubo Multiartista Online - Corrigido</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/photon-web-sdk@4.1.0/dist/photon-sdk-js.min.js"></script>
    
    <script src="config.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #111; font-family: sans-serif; }
        #status-display {
            position: absolute; top: 10px; left: 10px;
            background: rgba(0,0,0,0.8); color: #0f0;
            padding: 10px; border-radius: 5px; z-index: 100;
            border: 1px solid #444;
        }
    </style>
</head>
<body>

    <div id="status-display">Status: Verificando bibliotecas...</div>

    <script>
    let scene, camera, renderer, myCube;
    let client;
    let otherPlayers = {};
    const keys = {};

    function initThree() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Luz e Chão
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        scene.add(new THREE.GridHelper(50, 50));

        // Meu Personagem
        myCube = new THREE.Mesh(
            new THREE.BoxGeometry(1, 1, 1),
            new THREE.MeshStandardMaterial({ color: 0x00ff00 })
        );
        scene.add(myCube);
        camera.position.set(0, 5, 10);
    }

    function initPhoton() {
        const statusText = document.getElementById('status-display');

        // VERIFICAÇÃO CRUCIAL: Se o Photon não carregou, ele avisa aqui em vez de dar erro no console
        if (typeof Photon === 'undefined') {
            statusText.innerText = "ERRO: Biblioteca Photon não encontrada!";
            statusText.style.color = "red";
            return;
        }

        client = new Photon.LoadBalancing.LoadBalancingClient(
            Photon.ConnectionProtocol.Wss, 
            SERVER_CONFIG.APP_ID, 
            SERVER_CONFIG.APP_VERSION
        );

        client.onStateChange = (state) => {
            statusText.innerText = "Status: " + Photon.LoadBalancing.Handlers.StateToName(state);
            if (state === Photon.LoadBalancing.LoadBalancingClient.State.ConnectedToMaster) {
                client.joinOrCreateRoom("SalaPrincipal");
            }
        };

        // Receber movimento dos outros
        client.onEvent = (code, content, actorNr) => {
            if (code === 2) {
                if (!otherPlayers[actorNr]) {
                    otherPlayers[actorNr] = new THREE.Mesh(
                        new THREE.BoxGeometry(1, 1, 1),
                        new THREE.MeshStandardMaterial({ color: 0xff00ff })
                    );
                    scene.add(otherPlayers[actorNr]);
                }
                otherPlayers[actorNr].position.set(content.x, content.y, content.z);
            }
        };

        client.connectToRegionMaster(SERVER_CONFIG.REGION);
    }

    function animate() {
        requestAnimationFrame(animate);
        
        // Movimentação básica
        const speed = 0.1;
        let moved = false;
        if(keys['w']) { myCube.position.z -= speed; moved = true; }
        if(keys['s']) { myCube.position.z += speed; moved = true; }
        if(keys['a']) { myCube.position.x -= speed; moved = true; }
        if(keys['d']) { myCube.position.x += speed; moved = true; }

        if(moved && client && client.isJoinedToRoom()) {
            client.raiseEvent(2, { x: myCube.position.x, y: myCube.position.y, z: myCube.position.z });
        }

        camera.lookAt(myCube.position);
        renderer.render(scene, camera);
    }

    window.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);

    // INICIAR TUDO APENAS QUANDO A PÁGINA ESTIVER PRONTA
    window.onload = () => {
        initThree();
        initPhoton();
        animate();
    };
    </script>
</body>
</html>
